# BOTD #2: Peer Protocol


## Overview 

All communications between two parties are encrypted in order to provide confidentiality for all transcripts and is authenticated in order to avoid malicious interference. Each node has a known long-term identifier that is a public key on Bitcoin's secp256k1 curve. This long-term public key is used within the protocol to establish an encrypted and authenticated connection with peers, and also to authenticate any information advertised on behalf of a node.

An initial handshake is required to establish a secure TCP-based session between two nodes. The default listening TCP port is **9945** 



## Handshake

Prior to undertaking the handshake it is assumed that we have already established a dedicated bidirectional channel between both parties. Both peers generate an ephemeral keypair using the secp256 elliptic curve algorithm.

### Data Structures

```protobuf
syntax = "proto3";

message Init {
	// Random unique identifier for the current message
	string id = 1;
	// Secp256k1 Sender's public key 
	bytes sender_pubkey = 2;
	// Secp256k1 Recipient's public key 
	bytes recipient_pubkey = 3;
	// Ephemeral public key generated by the sender
	bytes ephemeral_pubkey = 4;
        // secp256k1 signature of sha256(sender_pubkey,recipient_pubkey,sender_ephemeral_pubkey)
	bytes signature = 5;
}

message Ack {
	// Random unique identifier for the current message
	string id = 1;
	// indetifier of the Init message
	string init_id = 2;
	// Ephemeral public key generated by the recipient
	bytes ephemeral_pubkey = 3;
	// secp256k1 signature of sha256(recipient_pubkey,sender_pubkey,recipient_ephemeral_pubkey)
	bytes signature = 4;
}

```

### Init

In this phase the local peer (sender) crafts and sends over the wire a message containing his permanent public key and the remote peer's one (recipient). The ephemeral public key is added in this step, along with a signature used by the peer to authenticate.

The remote peer MUST close the connection if the signature does not validate.


### Ack 

Once the remote peer receives and validates the Init message, he crafts and sends over the wire a message containing his ephemeral public key and his computed signature.

The local peer MUST close the connection if the signature does not validate.


### Shared Secret Generation

Peers now generate their shared secret by combining their ephemeral private key with the remote peer's ephemeral public key. Further communication MUST be encrypted with aes-256 symmetric encryption.

## Control 

In order to allow for the existence of long-lived TCP connections, at times it may be required that both ends keep alive the TCP connection at the application level. 


### Data Structures

```protobuf

message Ping {
	// random unique indetifier for the current message
	string id = 1;
}

message Pong {
	// random unique indetifier for the current message
	string id = 1;
	// indetifier of the Ping message
	string ping_id = 2;
}

```

### Ping/Pong

A node sending a ping message:
* SHOULD NOT send ping messages more often than once every 30 seconds
* if it doesn't receive a corresponding pong MAY terminate the network connection

A node receiving a ping message:
* SHOULD close the channel if it receives more than one ping from the same peer in the 30 second window
	






	
